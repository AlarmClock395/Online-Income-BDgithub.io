<!doctype html>
<html lang="bn">
<link rel="shortcut icon" href="Profile.png" type="image/p-icon">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>প্রোফাইল - Online Income BD</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* Modern Color Palette */
    :root{
      /* Primary Colors - Modern gradient theme */
      --primary: #6a11cb;
      --primary-dark: #4a00e0;
      --secondary: #2575fc;
      --accent: #ff6b6b;
      --success: #00d68f;
      --warning: #ffaa00;
      --danger: #ff3d71;
      --text-light: #ffffff;
      --text-dark: #2c3e50;
      --text-muted: #6c757d;
      --card-bg: #ffffff;
      --body-bg: #f5f7fa;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      --gradient-success: linear-gradient(135deg, #00d68f 0%, #00a854 100%);
      --gradient-warning: linear-gradient(135deg, #ffaa00 0%, #ff6b00 100%);
      --gradient-danger: linear-gradient(135deg, #ff3d71 0%, #c71e37 100%);
      --workup-green: #00b875;
      --workup-blue: #3293a3;
      --dark-bg: #1c212e;
      --bell-color: #00e676;
    }
    
    * {
      box-sizing: border-box;
      font-family: 'Noto Sans Bengali', 'Poppins', sans-serif;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--body-bg);
      color: var(--text-dark);
    }
    
    /* Profile Container */
    .profile-container {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    
    /* Profile Card */
    .profile-card {
      width: 100%;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      position: relative;
      z-index: 1;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .profile-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--gradient-primary);
    }
    
    /* Profile Header */
    .profile-header {
      background: var(--gradient-primary);
      color: var(--text-light);
      padding: 30px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .profile-avatar-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 36px;
      font-weight: 700;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .profile-details h2 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }
    
    .profile-details p {
      margin: 5px 0 0;
      opacity: 0.9;
      font-size: 16px;
    }
    
    .profile-details .referral-code {
      font-size: 14px;
      background: rgba(255, 255, 255, 0.2);
      padding: 5px 10px;
      border-radius: 20px;
      display: inline-block;
      margin-top: 8px;
    }
    
    /* Profile Body */
    .profile-body {
      padding: 25px;
    }
    
    .profile-stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(106, 17, 203, 0.05);
      border-radius: 15px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    /* Profile Menu */
    .profile-menu-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .profile-menu-item {
      padding: 15px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .profile-menu-item:last-child {
      border-bottom: none;
    }
    
    .profile-menu-item:hover {
      background-color: rgba(106, 17, 203, 0.05);
      margin: 0 -10px;
      padding: 15px 10px;
      border-radius: 8px;
    }
    
    .profile-menu-item i {
      color: var(--primary);
      width: 24px;
      font-size: 20px;
    }
    
    .profile-menu-item .menu-text {
      flex-grow: 1;
      font-weight: 500;
    }
    
    .profile-menu-item .menu-arrow {
      color: var(--text-muted);
    }
    
    /* Profile Footer */
    .profile-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }
    
    .btn {
      flex: 1;
      background: var(--gradient-primary);
      border: 0;
      color: var(--text-light);
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(106, 17, 203, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(106, 17, 203, 0.3);
    }
    
    .btn-danger {
      background: var(--gradient-danger);
      box-shadow: 0 4px 10px rgba(255, 61, 113, 0.2);
    }
    
    .btn-danger:hover {
      box-shadow: 0 6px 15px rgba(255, 61, 113, 0.3);
    }
    
    /* Change Password Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 15px;
      z-index: 100;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      width: 100%;
      max-width: 380px;
      background: var(--card-bg);
      padding: 0;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    
    .modal-header {
      background: var(--gradient-primary);
      color: var(--text-light);
      padding: 20px;
      font-size: 20px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .input-group {
      position: relative;
      margin: 15px 0;
    }
    
    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 18px;
      z-index: 5;
    }
    
    .input {
      width: 100%;
      padding: 15px 15px 15px 45px;
      margin: 0;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #f9f9f9;
    }
    
    .input:focus {
      border-color: var(--primary);
      outline: none;
      background: white;
      box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
    }
    
    .input:focus + i {
      color: var(--primary);
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }
    
    .modal-footer .btn {
      flex: 1;
    }
    
    .modal-footer .btn-secondary {
      background: #e0e0e0;
      color: var(--text-dark);
    }
    
    .modal-footer .btn-secondary:hover {
      background: #d0d0d0;
    }
    
    .message {
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: 500;
      display: none;
    }
    
    .message.success {
      background: rgba(0, 214, 143, 0.1);
      color: var(--success);
      border: 1px solid rgba(0, 214, 143, 0.3);
    }
    
    .message.error {
      background: rgba(255, 61, 113, 0.1);
      color: var(--danger);
      border: 1px solid rgba(255, 61, 113, 0.3);
    }
    
    /* Back Button */
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    
    .back-btn:hover {
      background: white;
      transform: translateX(-3px);
    }
    
    /* Transaction History Styles */
    .transaction-list {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    
    .transaction-item {
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      background: rgba(106, 17, 203, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .transaction-info {
      flex-grow: 1;
    }
    
    .transaction-amount {
      font-weight: 600;
      font-size: 16px;
    }
    
    .transaction-status {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: 500;
    }
    
    .status-approved {
      background: rgba(0, 214, 143, 0.1);
      color: var(--success);
    }
    
    .status-pending {
      background: rgba(255, 170, 0, 0.1);
      color: var(--warning);
    }
    
    .status-cancelled {
      background: rgba(255, 61, 113, 0.1);
      color: var(--danger);
    }
    
    .transaction-date {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 3px;
    }
    
    .empty-history {
      text-align: center;
      padding: 30px;
      color: var(--text-muted);
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .profile-container {
        padding: 10px;
      }
      
      .profile-header {
        padding: 25px 15px;
      }
      
      .profile-avatar-large {
        width: 70px;
        height: 70px;
        font-size: 30px;
      }
      
      .profile-details h2 {
        font-size: 20px;
      }
      
      .profile-details p {
        font-size: 14px;
      }
      
      .profile-stats {
        padding: 15px;
      }
      
      .stat-value {
        font-size: 24px;
      }
      
      .profile-body {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <div class="back-btn" id="backBtn">
      <i class="fa-solid fa-arrow-left"></i>
    </div>
    
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-avatar-large" id="profileAvatarLarge">U</div>
        <div class="profile-details">
          <h2 id="profileNameLarge">User Name</h2>
          <p id="profileEmailLarge">user@example.com</p>
          <div class="referral-code">রেফার কোড: <span id="referralCodeLarge">XXXXXX</span></div>
        </div>
      </div>
      
      <div class="profile-body">
        <div class="profile-stats">
          <div class="stat-item">
            <div class="stat-value" id="totalPoints">0</div>
            <div class="stat-label">মোট পয়েন্ট</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="totalTasks">0</div>
            <div class="stat-label">সম্পন্ন কাজ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="referralCount">0</div>
            <div class="stat-label">রেফারেল</div>
          </div>
        </div>
        
        <ul class="profile-menu-list">
          <li class="profile-menu-item" id="editProfileBtn">
            <i class="fa-solid fa-user-edit"></i>
            <span class="menu-text">প্রোফাইল সম্পাদনা করুন</span>
            <i class="fa-solid fa-chevron-right menu-arrow"></i>
          </li>
          <li class="profile-menu-item" id="changePasswordBtn">
            <i class="fa-solid fa-key"></i>
            <span class="menu-text">পাসওয়ার্ড পরিবর্তন করুন</span>
            <i class="fa-solid fa-chevron-right menu-arrow"></i>
          </li>
          <li class="profile-menu-item" id="historyBtn">
            <i class="fa-solid fa-history"></i>
            <span class="menu-text">লেনদেনের ইতিহাস</span>
            <i class="fa-solid fa-chevron-right menu-arrow"></i>
          </li>
          <li class="profile-menu-item" id="supportBtn">
            <i class="fa-solid fa-headset"></i>
            <span class="menu-text">সাপোর্ট</span>
            <i class="fa-solid fa-chevron-right menu-arrow"></i>
          </li>
        </ul>
      </div>
      
      <div class="profile-footer">
        <button class="btn" id="homeBtn">
          <i class="fa-solid fa-home"></i> হোম
        </button>
        <button class="btn btn-danger" id="logoutBtn">
          <i class="fa-solid fa-sign-out-alt"></i> লগআউট
        </button>
      </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
      <div class="modal-content">
        <div class="modal-header">
          <span>প্রোফাইল সম্পাদনা</span>
          <i class="fa-solid fa-times" id="closeEditModal" style="cursor: pointer;"></i>
        </div>
        <div class="modal-body">
          <div class="message" id="editProfileMessage"></div>
          
          <div class="input-group">
            <input type="text" id="editName" class="input" placeholder="আপনার নাম">
            <i class="fa-solid fa-user"></i>
          </div>
          
          <div class="input-group">
            <input type="email" id="editEmail" class="input" placeholder="ইমেল ঠিকানা" readonly>
            <i class="fa-solid fa-envelope"></i>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelEditProfile">বাতিল</button>
          <button class="btn" id="saveEditProfile">সংরক্ষণ করুন</button>
        </div>
      </div>
    </div>
    
    <!-- Transaction History Modal -->
    <div class="modal" id="historyModal">
      <div class="modal-content">
        <div class="modal-header">
          <span>লেনদেনের ইতিহাস</span>
          <i class="fa-solid fa-times" id="closeHistoryModal" style="cursor: pointer;"></i>
        </div>
        <div class="modal-body">
          <div id="transactionList" class="transaction-list">
            <div class="empty-history">লোড হচ্ছে...</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="closeHistory">বন্ধ করুন</button>
        </div>
      </div>
    </div>
    
    <!-- Support Modal -->
    <div class="modal" id="supportModal">
      <div class="modal-content">
        <div class="modal-header">
          <span>সাপোর্ট</span>
          <i class="fa-solid fa-times" id="closeSupportModal" style="cursor: pointer;"></i>
        </div>
        <div class="modal-body">
          <div style="text-align: center; padding: 20px 0;">
            <i class="fa-solid fa-headset" style="font-size: 48px; color: var(--primary); margin-bottom: 15px;"></i>
            <h3 style="margin-bottom: 10px;">আমাদের সাথে যোগাযোগ করুন</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px;">যেকোনো সমস্যার জন্য আমাদের সাপোর্ট টিমের সাথে যোগাযোগ করুন</p>
            
            <a href="https://api.whatsapp.com/send/?phone=01873882502&text&type=phone_number&app_absent=0&wame_ctl=1" 
               target="_blank" class="btn" style="background: #25D366; max-width: 250px; margin: 0 auto;">
              <i class="fa-brands fa-whatsapp"></i> WhatsApp সাপোর্ট
            </a>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="closeSupport">বন্ধ করুন</button>
        </div>
      </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
      <div class="modal-content">
        <div class="modal-header">
          <span>পাসওয়ার্ড পরিবর্তন</span>
          <i class="fa-solid fa-times" id="closePasswordModal" style="cursor: pointer;"></i>
        </div>
        <div class="modal-body">
          <div class="message" id="passwordMessage"></div>
          
          <div class="input-group">
            <input type="password" id="currentPassword" class="input" placeholder="বর্তমান পাসওয়ার্ড">
            <i class="fa-solid fa-lock"></i>
          </div>
          
          <div class="input-group">
            <input type="password" id="newPassword" class="input" placeholder="নতুন পাসওয়ার্ড">
            <i class="fa-solid fa-key"></i>
          </div>
          
          <div class="input-group">
            <input type="password" id="confirmPassword" class="input" placeholder="নতুন পাসওয়ার্ড নিশ্চিত করুন">
            <i class="fa-solid fa-check-circle"></i>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancelPasswordChange">বাতিল</button>
          <button class="btn" id="submitPasswordChange">পরিবর্তন করুন</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /**************
   * IMPORTANT *
   * Replace the firebaseConfig object below with your project's config from Firebase Console.
   **************/
  const firebaseConfig = {
        apiKey: "AIzaSyARwuMKNRPwqvaq2HnM-cW52ZVoTrDOLIQ",
  authDomain: "walletsystem-808df.firebaseapp.com",
  databaseURL: "https://walletsystem-808df-default-rtdb.firebaseio.com",
  projectId: "walletsystem-808df",
  storageBucket: "walletsystem-808df.firebasestorage.app",
  messagingSenderId: "674874233210",
  appId: "1:674874233210:web:8588b19e748883182246c3",
  measurementId: "G-H7P92Y37HL"
};
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // UI Elements
  const profileAvatarLarge = document.getElementById('profileAvatarLarge');
  const profileNameLarge = document.getElementById('profileNameLarge');
  const profileEmailLarge = document.getElementById('profileEmailLarge');
  const referralCodeLarge = document.getElementById('referralCodeLarge');
  const totalPoints = document.getElementById('totalPoints');
  const totalTasks = document.getElementById('totalTasks');
  const referralCount = document.getElementById('referralCount');
  const backBtn = document.getElementById('backBtn');
  const homeBtn = document.getElementById('homeBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  
  // Modal Elements
  const editProfileModal = document.getElementById('editProfileModal');
  const closeEditModal = document.getElementById('closeEditModal');
  const cancelEditProfile = document.getElementById('cancelEditProfile');
  const saveEditProfile = document.getElementById('saveEditProfile');
  const editName = document.getElementById('editName');
  const editEmail = document.getElementById('editEmail');
  const editProfileMessage = document.getElementById('editProfileMessage');
  
  const historyModal = document.getElementById('historyModal');
  const closeHistoryModal = document.getElementById('closeHistoryModal');
  const closeHistory = document.getElementById('closeHistory');
  const transactionList = document.getElementById('transactionList');
  
  const supportModal = document.getElementById('supportModal');
  const closeSupportModal = document.getElementById('closeSupportModal');
  const closeSupport = document.getElementById('closeSupport');
  
  const changePasswordModal = document.getElementById('changePasswordModal');
  const closePasswordModal = document.getElementById('closePasswordModal');
  const cancelPasswordChange = document.getElementById('cancelPasswordChange');
  const submitPasswordChange = document.getElementById('submitPasswordChange');
  const currentPassword = document.getElementById('currentPassword');
  const newPassword = document.getElementById('newPassword');
  const confirmPassword = document.getElementById('confirmPassword');
  const passwordMessage = document.getElementById('passwordMessage');
  
  // Menu Items
  const editProfileBtn = document.getElementById('editProfileBtn');
  const changePasswordBtn = document.getElementById('changePasswordBtn');
  const historyBtn = document.getElementById('historyBtn');
  const supportBtn = document.getElementById('supportBtn');
  
  // User data reference
  let currentUserRef = null;

  // Check if user is logged in
  auth.onAuthStateChanged(user => {
    if (!user) {
      // If not logged in, redirect to main page
      window.location.href = 'index.html';
      return;
    }
    
    const uid = user.uid;
    currentUserRef = db.ref('users/' + uid);
    
    // Load user data
    currentUserRef.once('value').then(snap => {
      const data = snap.val() || {};
      
      // Update profile display
      const userName = data.name || 'User';
      profileNameLarge.textContent = userName;
      profileEmailLarge.textContent = data.email || user.email;
      referralCodeLarge.textContent = data.referralCode || uid.substring(0, 6).toUpperCase();
      
      // Get first letter of name for avatar
      const firstLetter = userName.charAt(0).toUpperCase();
      profileAvatarLarge.textContent = firstLetter;
      
      // Update stats
      totalPoints.textContent = (data.points || 0).toFixed(1);
      totalTasks.textContent = data.todayCount || 0;
      
      // Get referral count (placeholder - would need to be calculated from database)
      referralCount.textContent = '0'; // Placeholder
    });
  });

  // Navigation
  backBtn.addEventListener('click', () => {
    window.location.href = 'index.html';
  });
  
  homeBtn.addEventListener('click', () => {
    window.location.href = 'index.html';
  });
  
  logoutBtn.addEventListener('click', () => {
    auth.signOut().then(() => {
      window.location.href = 'index.html';
    });
  });

  // Menu Items
  editProfileBtn.addEventListener('click', () => {
    // Load current user data into edit form
    if (auth.currentUser && currentUserRef) {
      currentUserRef.once('value').then(snap => {
        const data = snap.val() || {};
        editName.value = data.name || '';
        editEmail.value = data.email || auth.currentUser.email;
      });
    }
    editProfileModal.classList.add('active');
  });

  changePasswordBtn.addEventListener('click', () => {
    changePasswordModal.classList.add('active');
  });

  historyBtn.addEventListener('click', () => {
    loadTransactionHistory();
    historyModal.classList.add('active');
  });

  supportBtn.addEventListener('click', () => {
    supportModal.classList.add('active');
  });

  // Edit Profile Modal
  closeEditModal.addEventListener('click', () => {
    editProfileModal.classList.remove('active');
    clearEditProfileForm();
  });

  cancelEditProfile.addEventListener('click', () => {
    editProfileModal.classList.remove('active');
    clearEditProfileForm();
  });

  saveEditProfile.addEventListener('click', () => {
    const newName = editName.value.trim();
    
    // Reset message
    editProfileMessage.style.display = 'none';
    editProfileMessage.className = 'message';
    
    // Validation
    if (!newName) {
      showEditProfileMessage('নাম ফিল্ডটি পূরণ করুন', 'error');
      return;
    }
    
    if (newName.length < 3) {
      showEditProfileMessage('নাম কমপক্ষে 3 অক্ষর হতে হবে', 'error');
      return;
    }
    
    // Update user profile in Firebase
    const user = auth.currentUser;
    
    // Update display name in Firebase Auth
    user.updateProfile({ displayName: newName })
      .then(() => {
        // Update name in Realtime Database
        return currentUserRef.update({ name: newName });
      })
      .then(() => {
        // Update UI
        profileNameLarge.textContent = newName;
        const firstLetter = newName.charAt(0).toUpperCase();
        profileAvatarLarge.textContent = firstLetter;
        
        showEditProfileMessage('প্রোফাইল সফলভাবে আপডেট হয়েছে!', 'success');
        
        // Close modal after success
        setTimeout(() => {
          editProfileModal.classList.remove('active');
          clearEditProfileForm();
        }, 2000);
      })
      .catch(error => {
        console.error('Profile update error:', error);
        showEditProfileMessage('প্রোফাইল আপডেটে ত্রুটি: ' + error.message, 'error');
      });
  });

  // Transaction History Modal
  closeHistoryModal.addEventListener('click', () => {
    historyModal.classList.remove('active');
  });

  closeHistory.addEventListener('click', () => {
    historyModal.classList.remove('active');
  });

  function loadTransactionHistory() {
    if (!auth.currentUser) return;
    
    const uid = auth.currentUser.uid;
    const transactionsRef = db.ref(`withdraw_requests/${uid}`);
    
    transactionList.innerHTML = '<div class="empty-history">লোড হচ্ছে...</div>';
    
    transactionsRef.once('value').then(snap => {
      const transactions = snap.val() || {};
      const transactionKeys = Object.keys(transactions);
      
      if (transactionKeys.length === 0) {
        transactionList.innerHTML = '<div class="empty-history">কোনো লেনদেনের ইতিহাস পাওয়া যায়নি</div>';
        return;
      }
      
      transactionList.innerHTML = '';
      
      // Sort transactions by timestamp (newest first)
      transactionKeys.sort((a, b) => {
        return transactions[b].timestamp - transactions[a].timestamp;
      });
      
      transactionKeys.forEach(key => {
        const transaction = transactions[key];
        const date = new Date(transaction.timestamp);
        const formattedDate = date.toLocaleDateString('bn-BD', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
        });
        
        const statusClass = transaction.status === 'approved' ? 'status-approved' : 
                           transaction.status === 'cancelled' ? 'status-cancelled' : 
                           'status-pending';
        
        const statusText = transaction.status === 'approved' ? 'অনুমোদিত' : 
                          transaction.status === 'cancelled' ? 'বাতিল' : 
                          'অপেক্ষমান';
        
        const transactionItem = document.createElement('div');
        transactionItem.className = 'transaction-item';
        transactionItem.innerHTML = `
          <div class="transaction-info">
            <div class="transaction-amount">${transaction.amount || 0} পয়েন্ট</div>
            <div class="transaction-date">${formattedDate}</div>
          </div>
          <div class="transaction-status ${statusClass}">${statusText}</div>
        `;
        
        transactionList.appendChild(transactionItem);
      });
    }).catch(error => {
      console.error('Transaction history error:', error);
      transactionList.innerHTML = '<div class="empty-history">লেনদেনের ইতিহাস লোড করতে ত্রুটি হয়েছে</div>';
    });
  }

  // Support Modal
  closeSupportModal.addEventListener('click', () => {
    supportModal.classList.remove('active');
  });

  closeSupport.addEventListener('click', () => {
    supportModal.classList.remove('active');
  });

  // Password Change Modal
  closePasswordModal.addEventListener('click', () => {
    changePasswordModal.classList.remove('active');
    clearPasswordForm();
  });

  cancelPasswordChange.addEventListener('click', () => {
    changePasswordModal.classList.remove('active');
    clearPasswordForm();
  });

  submitPasswordChange.addEventListener('click', () => {
    const currentPass = currentPassword.value.trim();
    const newPass = newPassword.value.trim();
    const confirmPass = confirmPassword.value.trim();
    
    // Reset message
    passwordMessage.style.display = 'none';
    passwordMessage.className = 'message';
    
    // Validation
    if (!currentPass || !newPass || !confirmPass) {
      showPasswordMessage('সমস্ত ফিল্ড পূরণ করুন', 'error');
      return;
    }
    
    if (newPass.length < 6) {
      showPasswordMessage('নতুন পাসওয়ার্ড কমপক্ষে 6 অক্ষর হওয়া উচিত', 'error');
      return;
    }
    
    if (newPass !== confirmPass) {
      showPasswordMessage('নতুন পাসওয়ার্ড মিলছে না', 'error');
      return;
    }
    
    // Get current user
    const user = auth.currentUser;
    
    // Re-authenticate user
    const credential = firebase.auth.EmailAuthProvider.credential(
      user.email,
      currentPass
    );
    
    user.reauthenticateWithCredential(credential)
      .then(() => {
        // Update password
        return user.updatePassword(newPass);
      })
      .then(() => {
        showPasswordMessage('পাসওয়ার্ড সফলভাবে পরিবর্তন হয়েছে!', 'success');
        clearPasswordForm();
        
        // Close modal after success
        setTimeout(() => {
          changePasswordModal.classList.remove('active');
        }, 2000);
      })
      .catch(error => {
        console.error('Password change error:', error);
        if (error.code === 'auth/wrong-password') {
          showPasswordMessage('বর্তমান পাসওয়ার্ডটি ভুল', 'error');
        } else {
          showPasswordMessage('পাসওয়ার্ড পরিবর্তনে ত্রুটি: ' + error.message, 'error');
        }
      });
  });

  function showEditProfileMessage(message, type) {
    editProfileMessage.textContent = message;
    editProfileMessage.className = 'message ' + type;
    editProfileMessage.style.display = 'block';
  }

  function showPasswordMessage(message, type) {
    passwordMessage.textContent = message;
    passwordMessage.className = 'message ' + type;
    passwordMessage.style.display = 'block';
  }

  function clearEditProfileForm() {
    editName.value = '';
    editEmail.value = '';
    editProfileMessage.style.display = 'none';
  }

  function clearPasswordForm() {
    currentPassword.value = '';
    newPassword.value = '';
    confirmPassword.value = '';
    passwordMessage.style.display = 'none';
  }
  </script>
<script
  type="text/javascript"
  src="https://pl28251646.effectivegatecpm.com/35/a9/f5/35a9f5fd8ad42fe9d141218e1a8cd6f0.js"
></script>
</body>
</html>